<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="default-src * 'unsafe-inline' 'unsafe-eval'; script-src * 'unsafe-inline' 'unsafe-eval'; connect-src * 'unsafe-inline'; style-src * 'unsafe-inline';">
    <title>       BRAIN</title>
    
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
<script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>

    <style>
        body {
            background-color: #0a0a0a;
            margin: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            width: 100vw;
            font-family: ui-monospace, 'Cascadia Code', 'Source Code Pro', monospace;
            color: #d1d1d1;
            padding: 20px;
            box-sizing: border-box;
        }

        .engine-frame {
            width: 100%;
            max-width: 900px;
            height: 90vh;
            background: #1a1a1a;
            border: 1px solid #333;
            box-shadow: 0 0 50px rgba(220, 38, 38, 0.1);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .status-bar {
            background: #0f0f0f;
            padding: 10px 20px;
            font-size: 10px;
            letter-spacing: 1.5px;
            border-bottom: 1px solid #2a2a2a;
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: #666;
        }

        .chat-container {
            flex: 1;
            overflow-y: auto;
            padding: 24px;
            background: #595c54;
        }

        .chat-container::-webkit-scrollbar { width: 6px; }
        .chat-container::-webkit-scrollbar-track { background: #0a0a0a; }
        .chat-container::-webkit-scrollbar-thumb { background: #333; border-radius: 3px; }
        .chat-container::-webkit-scrollbar-thumb:hover { background: #444; }

        .message-block {
            margin-bottom: 20px;
            padding: 16px;
            border-left: 2px solid #333;
            background: rgba(255,255,255,0.02);
        }

        .user-row { 
            border-left-color: #555;
            background: rgba(255,255,255,0.03);
        }
        
        .brain-row { 
            border-left-color: #dc2626;
            background: rgba(220, 38, 38, 0.05);
        }

        .auth-gate {
            background: #1a1a1a;
            border: 1px solid #333;
            padding: 60px 40px;
            text-align: center;
            box-shadow: 0 0 50px rgba(220, 38, 38, 0.15);
            max-width: 500px;
            width: 100%;
        }

        input { 
            outline: none; 
            background: transparent;
        }
        
        input:focus {
            border-color: #dc2626;
        }
        
        .pulse-red {
            width: 8px; 
            height: 8px; 
            background: #dc2626; 
            border-radius: 50%;
            display: inline-block; 
            margin-right: 8px;
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse { 
            0% { opacity: 1; transform: scale(1); } 
            50% { opacity: 0.4; transform: scale(0.9); } 
            100% { opacity: 1; transform: scale(1); } 
        }

        .settings-panel {
            background: #0f0f0f;
            border-bottom: 1px solid #2a2a2a;
            padding: 12px 20px;
        }

        .btn-icon {
            padding: 6px;
            color: #666;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-icon:hover {
            color: #dc2626;
        }

        button:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }
        /* Reasoning Trace Styling */
.reasoning-container {
  background: #1a1a1a;
  border-left: 3px solid #4a9eff;
  margin: 10px 0;
  border-radius: 4px;
}

.reasoning-trigger {
  padding: 8px 12px;
  cursor: pointer;
  color: #4a9eff;
  font-family: 'Courier New', monospace;
  font-size: 0.8rem;
  display: flex;
  align-items: center;
}

.reasoning-content {
  padding: 12px;
  color: #a0a0a0;
  font-family: 'Courier New', monospace;
  font-size: 0.85rem;
  border-top: 1px solid #333;
  white-space: pre-wrap;
}

/* Formal Logic Math Styling */
.katex-display {
  margin: 1em 0;
  overflow-x: auto;
  overflow-y: hidden;
}
    </style>
</head>
<body>
    <div id="root"></div>

   <script type="text/babel">
    const { useState, useEffect, useRef } = React;

    // --- 1. ICONS ---
    const Settings = () => (
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
            <circle cx="12" cy="12" r="3"></circle><path d="M12 1v6m0 6v6"></path>
        </svg>
    );

    const Download = () => (
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
            <polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line>
        </svg>
    );

    const Trash = () => (
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
            <polyline points="3 6 5 6 21 6"></polyline>
            <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6"></path>
        </svg>
    );

    // --- 2. MESSAGE PROCESSOR ---
    const MessageContent = ({ content, role }) => {
        if (role === 'user') return <p>{content}</p>;

        const phaseMatch = content.match(/\[PHASE 1: LOGIC SCRATCHPAD\]([\s\S]*?)\[PHASE 2: FINAL OUTPUT\]([\s\S]*)/);
        
        let displayBody = content;
        let scratchpad = null;

        if (phaseMatch) {
            scratchpad = phaseMatch[1].trim();
            displayBody = phaseMatch[2].trim();
        }

        return (
            <div className="space-y-4">
                {scratchpad && (
                    <details className="mb-4 border border-red-900/30 bg-black/40 rounded">
                        <summary className="cursor-pointer p-2 text-[10px] text-red-500/50 uppercase tracking-[0.2em] hover:text-red-500 transition-colors">
                            â–¼ VIEW_LOGIC_TRACE
                        </summary>
                        <div className="p-3 text-xs text-blue-400 italic font-mono border-t border-red-900/20 leading-relaxed whitespace-pre-wrap">
                            {scratchpad}
                        </div>
                    </details>
                )}
                <div className="final-output">
                    {displayBody.split('\n').map((line, idx) => {
                        const isHeader = line.includes('THESIS:') || line.includes('ANTITHESIS:') || line.includes('SYNTHESIS:');
                        return (
                            <p key={idx} className={`${isHeader ? 'text-red-600 font-black mt-6 mb-2 tracking-tighter text-base' : 'mb-2 opacity-90'}`}>
                                {line}
                            </p>
                        );
                    })}
                </div>
            </div>
        );
    };

    // --- 3. MAIN APP ---
    const App = () => {
        const [messages, setMessages] = useState([]);
        const [input, setInput] = useState('');
        const [apiKey, setApiKey] = useState(localStorage.getItem('gemini_key') || '');
        const [isLocked, setIsLocked] = useState(!apiKey);
        const [loading, setLoading] = useState(false);
        const [activeModel, setActiveModel] = useState('Standby');
        const [showSettings, setShowSettings] = useState(false);
        const [strictMode, setStrictMode] = useState(true);
        const [memory, setMemory] = useState({});
        const [temperature, setTemperature] = useState(0.7);
        const scrollRef = useRef(null);

        const modelSequence = ['gemini-2.0-flash', 'gemini-1.5-flash', 'gemini-1.5-pro'];

        useEffect(() => {
            scrollRef.current?.scrollIntoView({ behavior: 'smooth' });
        }, [messages]);

        useEffect(() => {
            const storedMem = localStorage.getItem('brain_memory');
            if (storedMem) setMemory(JSON.parse(storedMem));
            const storedMsgs = localStorage.getItem('brain_messages');
            if (storedMsgs) setMessages(JSON.parse(storedMsgs));
        }, []);

        useEffect(() => {
            if (messages.length > 0) localStorage.setItem('brain_messages', JSON.stringify(messages));
        }, [messages]);

        const buildSystemPrompt = () => `
            You are ENGINE.V2, a rigorous logic system. 
            Protocol: 
            1. Use [PHASE 1: LOGIC SCRATCHPAD] for deconstruction.
            2. Use [PHASE 2: FINAL OUTPUT] for the Dialectic (THESIS, ANTITHESIS, SYNTHESIS).
            Current Memory: ${JSON.stringify(memory)}
            Strict Mode: ${strictMode}
        `;

        const runAutoInference = async () => {
            if (!input.trim() || loading) return;
            const userText = input;
            const sys = buildSystemPrompt();
            
            setInput('');
            setMessages(prev => [...prev, { role: 'user', content: userText }]);
            setLoading(true);

            let success = false;
            for (const modelId of modelSequence) {
                setActiveModel(`INF: ${modelId}`);
                try {
                    const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${modelId}:generateContent?key=${apiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            system_instruction: { parts: [{ text: sys }] },
                            contents: [{ parts: [{ text: `Analyze request: ${userText}` }] }],
                            generationConfig: { temperature, topP: 0.95 }
                        })
                    });
                    const data = await res.json();
                    if (res.ok && data.candidates?.[0]?.content?.parts?.[0]) {
                        const reply = data.candidates[0].content.parts[0].text;
                        setMessages(prev => [...prev, { role: 'brain', content: reply, model: modelId }]);
                        success = true;
                        break;
                    }
                } catch (e) { console.error(e); }
            }
            if (!success) setMessages(prev => [...prev, { role: 'brain', content: "CRITICAL_ERROR: SEQUENCE_INTERRUPTED" }]);
            setLoading(false);
            setActiveModel('Standby');
        };

        const exportData = () => {
            const data = { memory, messages, timestamp: new Date().toISOString() };
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `engine_dump_${Date.now()}.json`;
            a.click();
        };

        if (isLocked) return (
            <div className="auth-gate flex flex-col items-center justify-center h-screen bg-black">
                <h2 className="text-white font-bold tracking-[0.5em] mb-8">ENGINE_LOCKED</h2>
                <input 
                    type="password" 
                    className="bg-transparent border-b border-gray-800 text-center text-white mb-8 outline-none focus:border-red-600 transition-colors"
                    placeholder="API_KEY_REQUIRED"
                    onKeyDown={(e) => e.key === 'Enter' && e.target.value && (localStorage.setItem('gemini_key', e.target.value), setApiKey(e.target.value), setIsLocked(false))}
                />
            </div>
        );

        return (
            <div className="engine-frame flex flex-col h-screen bg-black text-gray-300 font-mono">
                {/* Status Bar */}
                <div className="p-4 border-b border-gray-900 flex justify-between items-center text-[10px]">
                    <div className="flex gap-4">
                        <span className={loading ? "text-red-500 animate-pulse" : "text-green-600"}>{loading ? 'EXECUTING' : 'IDLE'}</span>
                        <span className="text-gray-600">{activeModel}</span>
                    </div>
                    <div className="flex gap-4 cursor-pointer">
                        <span onClick={() => setShowSettings(!showSettings)}><Settings /></span>
                        <span onClick={exportData}><Download /></span>
                        <span onClick={() => {setMessages([]); localStorage.removeItem('brain_messages')}}><Trash /></span>
                    </div>
                </div>

                {/* Chat Area */}
                <div className="flex-1 overflow-y-auto p-6 space-y-8">
                    {messages.map((m, i) => (
                        <div key={i} className={`pl-6 border-l-2 ${m.role === 'user' ? 'border-gray-700' : 'border-red-600'}`}>
                            <div className="flex items-center gap-3 mb-2">
                                <span className={`text-[9px] font-black px-2 py-0.5 ${m.role === 'user' ? 'bg-gray-800' : 'bg-red-900/30 text-red-500'}`}>
                                    {m.role === 'user' ? 'OPERATOR' : 'ENGINE.V2'}
                                </span>
                                {m.model && <span className="text-[8px] opacity-30">{m.model}</span>}
                            </div>
                            <div className="text-sm leading-relaxed">
                                <MessageContent content={m.content} role={m.role} />
                            </div>
                        </div>
                    ))}
                    <div ref={scrollRef} />
                </div>

                {/* Input Bar */}
                <div className="p-6 border-t border-gray-900 bg-[#050505]">
                    <input 
                        className="w-full bg-transparent border-b border-gray-800 py-2 outline-none focus:border-red-600 transition-colors text-sm"
                        placeholder="INPUT_REASONING_PARAMETERS..."
                        value={input}
                        onChange={(e) => setInput(e.target.value)}
                        onKeyDown={(e) => e.key === 'Enter' && runAutoInference()}
                        disabled={loading}
                    />
                </div>
            </div>
        );
    };

    ReactDOM.render(<App />, document.getElementById('root'));
</script>
</body>
</html>
